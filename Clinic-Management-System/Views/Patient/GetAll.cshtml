@model List<Patient>
@{
    ViewData["Title"] = "قائمة المرضى";
    string currentSort = ViewData["CurrentSort"]?.ToString();
    string currentFilter = ViewData["CurrentFilter"]?.ToString();
}

<div class="container py-4">
    <!-- ✅ رسائل نجاح / تعديل / حذف -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success text-center rounded-3 shadow-sm" id="alertBox">
            <i class="bi bi-check-circle-fill"></i> @TempData["SuccessMessage"]
        </div>
    }
    else if (TempData["EditMessage"] != null)
    {
        <div class="alert alert-warning text-center rounded-3 shadow-sm" id="alertBox">
            <i class="bi bi-pencil-square"></i> @TempData["EditMessage"]
        </div>
    }
    else if (TempData["DeleteMessage"] != null)
    {
        <div class="alert alert-danger text-center rounded-3 shadow-sm" id="alertBox">
            <i class="bi bi-trash-fill"></i> @TempData["DeleteMessage"]
        </div>
    }

    <!-- ✅ الكارد المودرن -->
    <div class="card card-modern mt-3">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="text-primary fw-bold"><i class="bi bi-people"></i> قائمة المرضى</h3>
            <a asp-action="Create" class="btn btn-primary px-3">
                <i class="bi bi-plus-circle"></i> إضافة مريض جديد
            </a>
        </div>

        <!-- ✅ نموذج البحث -->
        <form asp-action="GetAll" method="get" class="row g-2 mb-3 align-items-center">
            <div class="col-md-6">
                <input type="text" name="searchString" class="form-control border-2 rounded-3"
                       value="@currentFilter" placeholder="🔍 ابحث بالاسم أو الهاتف" style="border-color:#00B4D8;" />
            </div>

            <div class="col-md-4">
                <select class="form-select border-2 rounded-3" name="sortOrder" style="border-color:#00B4D8;">
                    <option value="">ترتيب حسب التسجيل</option>
                    <option value="Date_desc" selected="@(currentSort == "Date_desc")">الأحدث أولاً</option>
                    <option value="Age">الأصغر سناً</option>
                    <option value="Age_desc" selected="@(currentSort == "Age_desc")">الأكبر سناً</option>
                </select>
            </div>

            <div class="col-md-2 d-flex">
                <button type="submit" class="btn btn-primary w-50 me-1">بحث</button>
                <a asp-action="GetAll" class="btn btn-outline-secondary w-50">الكل</a>
            </div>
        </form>

        <!-- ✅ جدول المرضى -->
        <div class="table-responsive">
            <table class="table table-hover text-center align-middle table-modern">
                <thead class="table-primary">
                    <tr>
                        <th>رقم</th>
                        <th>الاسم</th>
                        <th>العنوان</th>
                        <th>الهاتف</th>
                        <th>النوع</th>
                        <th>التاريخ</th>
                        <th>العمر</th>
                        <th>السجل المرضي</th>
                        <th>إجراءات</th>
                    </tr>
                </thead>
                <tbody>
                    @if (!Model.Any())
                    {
                        <tr><td colspan="9" class="text-warning fw-bold">⚠ لا توجد نتائج</td></tr>
                    }
                    else
                    {
                        @foreach (var item in Model)
                        {
                            <tr>
                                <td>@item.Id</td>
                                <td>@item.FullName</td>
                                <td>@item.Address</td>
                                <td>@item.Phone</td>
                                <td>@item.Gender</td>
                                <td>@item.CreateAt.ToString("yyyy/MM/dd")</td>
                                <td>@item.Age</td>
                                <td>
                                    @if (item.MedicalRecords != null && item.MedicalRecords.Any())
                                    {
                                        foreach (var record in item.MedicalRecords)
                                        {
                                            <span class="badge bg-info text-dark me-1">@record</span>
                                        }
                                    }
                                    else
                                    {
                                        <span class="text-muted">لا يوجد</span>
                                    }
                                </td>
                                <td style="width:450px;">
                                    <div class="d-flex flex-wrap justify-content-center gap-1">
                                        <a asp-action="Details" asp-route-id="@item.Id" class="btn btn-outline-info btn-sm rounded-pill"> التفاصيل</a>
                                        <a asp-action="Edit" asp-route-id="@item.Id" class="btn btn-outline-warning btn-sm rounded-pill text-dark"> تعديل</a>
                                        <a asp-controller="Packages" asp-action="PatientPackages" asp-route-patientId="@item.Id"
                                           class="btn btn-outline-primary btn-sm rounded-pill"> الباقات</a>
                                        <a asp-controller="Checks" asp-action="Create" asp-route-patientId="@item.Id"
                                           class="btn btn-outline-success btn-sm rounded-pill"> إضافة كشف</a>
                                        <button type="button"
                                                onclick="openBookingPopupAjax('@item.Id', '@ViewBag.SelectedDate')"
                                                class="btn btn-success btn-sm rounded-pill">
                                            📆 حجز موعد
                                        </button>

                                        @if (item.Packages != null && item.Packages.Any())
                                        {
                                            <a asp-controller="TreatmentSession" asp-action="Create"
                                               asp-route-patientId="@item.Id"
                                               class="btn btn-outline-success btn-sm rounded-pill">
                                                ➕ بدء جلسة
                                            </a>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- ✅ نافذة تأكيد الحجز -->
<div class="modal fade" id="confirmBookingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">تأكيد الحجز</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                هل تريد تأكيد الحجز لهذا المريض في:
                <strong id="selectedDate"></strong> ؟
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">❌ إلغاء</button>
                <a id="confirmBookingBtn" class="btn btn-success">✅ تأكيد الحجز</a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // ✅ إخفاء الرسالة بعد 5 ثوانٍ
        setTimeout(() => {
            const alertBox = document.getElementById("alertBox");
            if (alertBox) {
                alertBox.style.opacity = "0";
                alertBox.style.transition = "opacity 1s ease";
                setTimeout(() => alertBox.remove(), 1000);
            }
        }, 5000);

        // ✅ Popup الحجز AJAX
        function openBookingPopupAjax(patientId, date) {
            if (!date) date = new Date().toISOString().split('T')[0];
            $.get('/Appointment/ConfirmBooking', { patientId: patientId, date: date + 'T09:00' })
                .done(function (html) {
                    $('#dynamicConfirmModal').remove();
                    var modalHtml = `
                        <div class="modal fade" id="dynamicConfirmModal" tabindex="-1">
                            <div class="modal-dialog">
                                <div class="modal-content">${html}</div>
                            </div>
                        </div>`;
                    $('body').append(modalHtml);
                    var modalEl = document.getElementById('dynamicConfirmModal');
                    var modal = new bootstrap.Modal(modalEl);
                    modal.show();
                })
                .fail(function () {
                    alert('فشل في تحميل نافذة تأكيد الحجز.');
                });
        }
    </script>

    <style>
        /* ✅ نفس نمط التقويم */
        .card-modern {
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 119, 182, 0.45);
            padding: 25px;
            border: 2px solid #0077B6;
            animation: fadeIn 0.4s ease;
        }

        .table-modern {
            border-radius: 12px;
            overflow: hidden;
            background: #ffffff;
            box-shadow: 0 4px 15px rgba(0, 119, 182, 0.25);
        }

            .table-modern th {
                background-color: #eaf9fb;
                color: #0077B6;
                font-weight: 700;
                border-bottom: 2px solid #00B4D8;
            }

            .table-modern td {
                border-color: #dee2e6;
                vertical-align: middle;
            }

            .table-modern tbody tr:hover {
                background-color: #f3fcfd !important;
                transition: background-color 0.2s ease;
            }

        .modal-dialog {
            margin-top: 120px !important; /* نزل المودال تحت */
        }

        @@keyframes fadeIn {
            from

        {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }

        }
    </style>
}
