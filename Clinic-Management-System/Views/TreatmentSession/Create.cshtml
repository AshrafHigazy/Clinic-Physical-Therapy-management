@model Clinic_Management_System.Models.Package
@{
    ViewData["Title"] = "إضافة باكدج جديدة";
}

<h2 class="mb-3">➕ إضافة باكدج جديدة</h2>

<form asp-action="Create" method="post">
    <input type="hidden" asp-for="PatientId" id="PatientId" />

    <!-- 🔹 Patient Search -->
    <div class="mb-3">
        <label class="form-label fw-bold">👤 المريض</label>
        @if (ViewBag.PatientId != null)
        {
            <input type="text" value="@ViewBag.PatientName" class="form-control" readonly />
        }
        else
        {
            <input type="text" id="patientSearch" class="form-control" placeholder="اكتب اسم المريض للبحث..." autocomplete="off" />
            <ul id="patientResults" class="list-group position-absolute w-50" style="z-index:1000; display:none;"></ul>
        }
        <span asp-validation-for="PatientId" class="text-danger"></span>
    </div>

    <!-- 🔹 Doctor (with search) -->
    <div class="mb-3">
        <label class="form-label fw-bold">🩺 الطبيب المشرف</label>
        <input type="text" id="doctorSearch" class="form-control" placeholder="ابحث عن الطبيب..." autocomplete="off" />
        <input type="hidden" asp-for="InternDoctorId" id="InternDoctorId" />
        <ul id="doctorResults" class="list-group position-absolute w-50" style="z-index:1000; display:none;"></ul>
        <span asp-validation-for="InternDoctorId" class="text-danger"></span>
    </div>

    <!-- 🔹 Organization -->
    <div class="mb-3">
        <label asp-for="OrganizationId" class="form-label fw-bold">🏢 المؤسسة</label>
        <select asp-for="OrganizationId" class="form-select" asp-items="@(new SelectList(ViewBag.Organizations, "OrganizationId", "Name"))">
            <option value="">-- اختر المؤسسة --</option>
        </select>
        <span asp-validation-for="OrganizationId" class="text-danger"></span>
    </div>

    <!-- 🔹 Check -->
    <div class="mb-3">
        <label asp-for="CheckId" class="form-label fw-bold">🩻 الفحص الطبي</label>
        <select asp-for="CheckId" class="form-select" asp-items="@(new SelectList(ViewBag.Checks, "CheckId", "ClinicAssessment"))">
            <option value="">-- اختر الفحص --</option>
        </select>
        <span asp-validation-for="CheckId" class="text-danger"></span>
    </div>

    <!-- 🔹 Package Info -->
    <div class="mb-3">
        <label asp-for="NumOfSessions" class="form-label fw-bold">📅 عدد الجلسات</label>
        <input asp-for="NumOfSessions" class="form-control" />
        <span asp-validation-for="NumOfSessions" class="text-danger"></span>
    </div>



    <button type="submit" class="btn btn-success mt-3">💾 حفظ الباكدج</button>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        // 🔎 Doctor Search
        $("#doctorSearch").on("input", function () {
            let term = $(this).val();
            if (term.length < 2) {
                $("#doctorResults").hide();
                return;
            }
            $.getJSON("/Packages/SearchDoctors", { term: term }, function (data) {
                let list = "";
                $.each(data, function (i, item) {
                    list += `<li class="list-group-item list-group-item-action" data-id="${item.id}">${item.name}</li>`;
                });
                $("#doctorResults").html(list).show();
            });
        });

        $(document).on("click", "#doctorResults li", function () {
            $("#InternDoctorId").val($(this).data("id"));
            $("#doctorSearch").val($(this).text());
            $("#doctorResults").hide();
        });

        // 🔎 Patient Search
        $("#patientSearch").on("input", function () {
            let term = $(this).val();
            if (term.length < 2) {
                $("#patientResults").hide();
                return;
            }
            $.getJSON("/Packages/SearchPatients", { term: term }, function (data) {
                let list = "";
                $.each(data, function (i, item) {
                    list += `<li class="list-group-item list-group-item-action" data-id="${item.id}">${item.name}</li>`;
                });
                $("#patientResults").html(list).show();
            });
        });

        $(document).on("click", "#patientResults li", function () {
            $("#PatientId").val($(this).data("id"));
            $("#patientSearch").val($(this).text());
            $("#patientResults").hide();
        });

        // إخفاء القايمه لما تخرج من الفوكس
        $(document).click(function (e) {
            if (!$(e.target).closest('#doctorSearch, #doctorResults').length) $("#doctorResults").hide();
            if (!$(e.target).closest('#patientSearch, #patientResults').length) $("#patientResults").hide();
        });
    </script>
}
