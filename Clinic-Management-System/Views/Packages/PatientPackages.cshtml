@model IEnumerable<Clinic_Management_System.Models.Package>

@{
    ViewData["Title"] = "باقات المريض";
}

<div class="container py-4">

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success fw-bold text-center rounded-3 shadow-sm" id="alertBox">
            @TempData["Success"]
        </div>
    }

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger fw-bold text-center rounded-3 shadow-sm" id="alertBox">
            @TempData["Error"]
        </div>
    }

    <!-- ✅ الكارد الرئيسي -->
    <div class="card card-modern">

        <!-- 🔹 العنوان + زر رجوع للمريض -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="text-primary fw-bold m-0">
                <i class="bi bi-box-seam"></i> باقات المريض:
                <span style="color: black;">@ViewBag.PatientName</span>   <!-- ✔ أصبح بالأسود -->
            </h3>

            <a asp-controller="Patient" asp-action="Details" asp-route-id="@ViewBag.PatientId"
               class="btn btn-outline-secondary rounded-pill px-3">
                <i class="bi bi-arrow-return-left"></i> رجوع للمريض
            </a>
        </div>


        <!-- 🔹 الأزرار -->
        <div class="d-flex gap-2 mb-3">
            <a asp-controller="Packages" asp-action="Create" asp-route-patientId="@ViewBag.PatientId"
               class="btn btn-success rounded-pill px-3">
                <i class="bi bi-plus-circle"></i> إضافة باقة جديدة
            </a>

            <a asp-controller="TreatmentSession" asp-action="Create" asp-route-patientId="@ViewBag.PatientId"
               class="btn attendance-btn rounded-pill px-3 ms-auto">
                <i class="bi bi-capsule"></i> تسجيل حضور جلسة
            </a>
        </div>


        <!-- 🔹 الجدول -->
        @if (!Model.Any())
        {
            <div class="alert alert-warning text-center fw-semibold rounded-3 shadow-sm">
                ⚠ لا توجد باقات لهذا المريض حالياً.
            </div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-hover table-modern text-center align-middle">
                    <thead class="table-primary text-dark">
                        <tr>
                            <th>الرقم</th>
                            <th>الطبيب المعالج</th>
                            <th>الجهة</th>
                            <th>تاريخ البداية</th>
                            <th>الحالة</th>
                            <th>تفاصيل الجلسات</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var pkg in Model.OrderByDescending(p => p.StartDate))
                        {
                            var isEnded = pkg.Status == "Ended";

                            <tr class="@(isEnded ? "table-light text-muted" : "")">
                                <td>@pkg.Id</td>
                                <td>@pkg.InternDoctor?.FullName</td>
                                <td>@pkg.Organization?.Name</td>
                                <td>@pkg.StartDate.ToString("yyyy/MM/dd")</td>

                                <td>
                                    @if (pkg.Status == "Active")
                                    {
                                        <span class="badge bg-success px-3 py-2">نشطة</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-danger px-3 py-2">منتهية</span>
                                    }
                                </td>

                                <!-- ✔ إجمالي / مستخدم / متبقي -->
                                <td>
                                    <div class="fw-bold text-primary">
                                        إجمالي: @pkg.NumOfSessions جلسات
                                    </div>
                                 
                                    <div class="text-success">
                                        المتبقي: <b>@pkg.RemainingSessions</b> جلسات
                                    </div>
                                    <div class="text-dark">
                                        <b>@pkg.UsedSessions</b> من أصل <b>@pkg.NumOfSessions</b> تم استخدامهم
                                    </div>
                                </td>

                                <td>
                                    <a asp-action="Details" asp-route-id="@pkg.Id"
                                       class="btn btn-sm btn-outline-info rounded-pill">
                                        <i class="bi bi-info-circle"></i> عرض التفاصيل
                                    </a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>

@section Scripts {
    <style>
        .attendance-btn {
            background-color: #023E8A; /* أزرق غامق شيك */
            border-color: #023E8A;
            color: #fff;
            font-weight: 600;
        }

            .attendance-btn:hover {
                background-color: #0353A4; /* درجة أفتح عند الـ hover */
                border-color: #0353A4;
                color: #fff !important;
            }

        /* 🌟 الكارد المودرن الموحد */
        .card-modern {
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 119, 182, 0.45);
            padding: 30px;
            border: 2px solid #0077B6;
            animation: fadeIn 0.4s ease;
        }

        /* 📋 الجدول الموحد */
        .table-modern {
            border-radius: 12px;
            overflow: hidden;
            background: #ffffff;
            box-shadow: 0 4px 15px rgba(0, 119, 182, 0.25);
        }

            .table-modern th {
                background-color: #eaf9fb !important;
                color: #0077B6 !important;
                font-weight: 700;
                border-bottom: 2px solid #00B4D8;
            }

            .table-modern td {
                border-color: #dee2e6;
                vertical-align: middle;
            }

            .table-modern tbody tr:hover {
                background-color: #f3fcfd !important;
                transition: 0.2s ease;
            }

        .btn-success {
            background-color: #00B4D8;
            border-color: #0077B6;
            font-weight: 600;
        }

            .btn-success:hover {
                background-color: #0096c7;
            }

        .btn-info {
            background-color: #0096c7;
            border-color: #0077B6;
            color: #fff;
        }

            .btn-info:hover {
                background-color: #0077B6;
            }

        .btn-outline-info:hover {
            background-color: #00B4D8;
            border-color: #00B4D8;
            color: #fff !important;
        }

        @@keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
}
